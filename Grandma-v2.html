<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>é˜¿å¬¤æ¢è¨ªé ç´„ç³»çµ± v2.1 - é›²ç«¯ç‰ˆ</title>
    <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@300;400;500;600;700&display=swap" rel="stylesheet">
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        body {
            font-family: 'Poppins', 'Microsoft JhengHei', sans-serif;
            background: linear-gradient(135deg, #E3F2FD 0%, #F1F8E9 100%);
            min-height: 100vh;
            padding: 20px;
        }
        .container { max-width: 1200px; margin: 0 auto; }
        .card, .header, .booking-list {
            background: #fff;
            border-radius: 1.5rem;
            box-shadow: 0 4px 24px rgba(25, 118, 210, 0.1);
            padding: 2rem;
        }
        .time-slot { transition: all 0.3s ease; border: 2px solid #e0e0e0; border-radius: 0.75rem; padding: 1rem; cursor: pointer; position: relative; }
        .time-slot.selected { border-color: #1976D2; background-color: #E3F2FD; box-shadow: 0 0 0 3px rgba(25, 118, 210, 0.2); }
        .calendar-day { border-radius: 0.75rem; min-height: 100px; padding: 8px; margin: 2px; background: #f8fafc; border: 1px solid #e2e8f0; }
        .calendar-day.full { background-color: #fee2e2; border-color: #ef4444; }
        .calendar-day.available { background-color: #f0fdf4; border-color: #22c55e; }
        .calendar-day.past { background-color: #f1f5f9; color: #94a3b8; cursor: not-allowed; }
        .delete-btn { background: #ef4444; color: white; padding: 4px 12px; border-radius: 0.5rem; font-size: 0.875rem; }
    </style>
</head>
<body>
    <div class="container">
        <div class="header text-center mb-10">
            <h1 class="text-4xl font-bold text-blue-600 mb-2">ğŸ¥ é˜¿å¬¤æ¢è¨ªé ç´„ç³»çµ±-v2.1</h1>
            <p class="text-gray-600">ç¾åœ¨æ”¯æ´ä¸€æ¬¡é ç´„å¤šäººï¼ˆä¸Šé™ 3 äººï¼‰</p>
            <div id="syncStatus" class="mt-3 text-sm font-medium text-blue-500">æ­£åœ¨é€£æ¥ Firebase...</div>
        </div>

        <div id="alertContainer"></div>

        <div class="grid grid-cols-1 lg:grid-cols-3 gap-8 mb-10">
            <div class="card lg:col-span-1">
                <h2 class="text-2xl font-semibold text-blue-600 mb-5 flex items-center gap-2">ğŸ“… é ç´„ç™»è¨˜</h2>
                <form id="bookingForm">
                    <div class="mb-5">
                        <label class="block font-medium mb-2">é¸æ“‡æ¢è¨ªæ—¥æœŸ</label>
                        <input type="date" id="visitDate" class="w-full p-3 border-2 rounded-lg focus:border-blue-500 outline-none" required>
                    </div>
                    <div class="mb-5">
                        <label class="block font-medium mb-2">é¸æ“‡æ¢è¨ªæ™‚æ®µ</label>
                        <div class="grid gap-3" id="timeSlots">
                            <div class="time-slot" data-slot="afternoon">
                                <span class="time-slot-badge absolute top-2 right-2 px-2 py-1 rounded-full text-[10px] text-white bg-gray-400">è®€å–ä¸­</span>
                                <div class="font-bold">â˜€ï¸ ä¸‹åˆæ™‚æ®µ</div>
                                <div class="text-xs text-gray-500">14:30 - 15:30</div>
                                <div class="text-sm mt-1">å·²é ç´„ï¼š<span id="afternoonCount">0</span>/3</div>
                            </div>
                            <div class="time-slot" data-slot="evening">
                                <span class="time-slot-badge absolute top-2 right-2 px-2 py-1 rounded-full text-[10px] text-white bg-gray-400">è®€å–ä¸­</span>
                                <div class="font-bold">ğŸŒ™ æ™šä¸Šæ™‚æ®µ</div>
                                <div class="text-xs text-gray-500">18:30 - 19:30</div>
                                <div class="text-sm mt-1">å·²é ç´„ï¼š<span id="eveningCount">0</span>/3</div>
                            </div>
                        </div>
                    </div>
                    <div class="mb-5">
                        <label class="block font-medium mb-2">ä¸»è¦è¨ªå®¢å§“å *</label>
                        <input type="text" id="visitorName" class="w-full p-3 border-2 rounded-lg focus:border-blue-500 outline-none" placeholder="è«‹è¼¸å…¥å§“å" required>
                    </div>
                    <div class="mb-5">
                        <label class="block font-medium mb-2">æ¢è¨ªäººæ•¸</label>
                        <select id="visitorCount" class="w-full p-3 border-2 rounded-lg focus:border-blue-500 outline-none">
                            <option value="1">1 äºº</option>
                            <option value="2">2 äºº</option>
                            <option value="3">3 äºº</option>
                        </select>
                        <p class="text-xs text-gray-400 mt-2">* æ¯å€‹æ™‚æ®µç¸½å…±åƒ…é™ 3 äººæ¢è¨ª</p>
                    </div>
                    <button type="submit" class="w-full bg-blue-600 text-white p-4 rounded-lg font-bold hover:bg-blue-700 transition">ç¢ºèªé ç´„</button>
                </form>
            </div>

            <div class="card lg:col-span-2">
                <div class="flex justify-between items-center mb-5">
                    <h2 class="text-2xl font-semibold text-blue-600">ğŸ“… æœˆæ›†ç¸½è¦½</h2>
                    <div class="flex gap-2">
                        <button id="prevMonth" class="bg-blue-600 text-white px-4 py-2 rounded-lg">â†</button>
                        <button id="nextMonth" class="bg-blue-600 text-white px-4 py-2 rounded-lg">â†’</button>
                    </div>
                </div>
                <div id="calendarView"></div>
            </div>
        </div>

        <div class="booking-list">
            <h2 class="text-2xl font-semibold text-blue-600 mb-5">ğŸ“ é ç´„è¨˜éŒ„</h2>
            <div id="bookingsList"></div>
        </div>
    </div>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
        import { getFirestore, collection, addDoc, onSnapshot, query, deleteDoc, doc, orderBy } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js";

        const firebaseConfig = {
            apiKey: "AIzaSyBEMARR3MhHhuJtTjpSJMKSuOdzwtirn1s",
            authDomain: "hospital-booking-5dee2.firebaseapp.com",
            projectId: "hospital-booking-5dee2",
            storageBucket: "hospital-booking-5dee2.firebasestorage.app",
            messagingSenderId: "164407619822",
            appId: "1:164407619822:web:242bd222a3837fc272c3ff"
        };

        const app = initializeApp(firebaseConfig);
        const db = getFirestore(app);
        const bookingsCol = collection(db, "bookings");

        let currentMonth = new Date().getMonth();
        let currentYear = new Date().getFullYear();
        let allBookings = [];

        onSnapshot(query(bookingsCol, orderBy("date")), (snapshot) => {
            allBookings = snapshot.docs.map(d => ({ id: d.id, ...d.data() }));
            renderUI();
            document.getElementById('syncStatus').innerHTML = "âœ… Firebase é›²ç«¯åŒæ­¥å·²å•Ÿç”¨";
            document.getElementById('syncStatus').className = "mt-3 text-sm font-medium text-green-600";
        }, (error) => {
            document.getElementById('syncStatus').innerHTML = "âŒ é€£æ¥å¤±æ•—: " + error.message;
            document.getElementById('syncStatus').className = "mt-3 text-sm font-medium text-red-600";
        });

        function renderUI() {
            renderBookingsList(allBookings);
            renderCalendar(allBookings);
            updateSlotCounts();
        }

        window.cancelBooking = async (id) => {
            if (confirm("ç¢ºå®šå–æ¶ˆé€™ç­†é ç´„å—ï¼Ÿ")) {
                await deleteDoc(doc(db, "bookings", id));
                showAlert("é ç´„å·²å–æ¶ˆ");
            }
        };

        document.getElementById('bookingForm').addEventListener('submit', async (e) => {
            e.preventDefault();
            const date = document.getElementById('visitDate').value;
            const name = document.getElementById('visitorName').value.trim();
            const count = parseInt(document.getElementById('visitorCount').value); // ç²å–äººæ•¸
            const slotEl = document.querySelector('.time-slot.selected');
            
            if (!slotEl) return showAlert("è«‹é¸æ“‡æ¢è¨ªæ™‚æ®µ", "error");
            const slot = slotEl.dataset.slot;

            // è¨ˆç®—ç›®å‰è©²æ™‚æ®µå·²é ç´„ç¸½äººæ•¸
            const currentTotal = allBookings
                .filter(b => b.date === date && b.slot === slot)
                .reduce((sum, b) => sum + (parseInt(b.count) || 1), 0);

            if (currentTotal + count > 3) {
                return showAlert(`åé¡ä¸è¶³ï¼è©²æ™‚æ®µåƒ…å‰© ${3 - currentTotal} å€‹åé¡ã€‚`, "error");
            }

            await addDoc(bookingsCol, { 
                date, 
                slot, 
                name, 
                count, // å­˜å…¥äººæ•¸
                created: Date.now() 
            });
            showAlert(`é ç´„æˆåŠŸï¼(${count}ä½)`);
            document.getElementById('visitorName').value = "";
            document.getElementById('visitorCount').value = "1";
        });

        document.querySelectorAll('.time-slot').forEach(el => {
            el.addEventListener('click', () => {
                document.querySelectorAll('.time-slot').forEach(e => e.classList.remove('selected'));
                el.classList.add('selected');
            });
        });

        document.getElementById('visitDate').addEventListener('change', updateSlotCounts);
        document.getElementById('prevMonth').addEventListener('click', () => { changeMonth(-1); });
        document.getElementById('nextMonth').addEventListener('click', () => { changeMonth(1); });

        function changeMonth(delta) {
            currentMonth += delta;
            if (currentMonth < 0) { currentMonth = 11; currentYear--; }
            else if (currentMonth > 11) { currentMonth = 0; currentYear++; }
            renderCalendar(allBookings);
        }

        function updateSlotCounts() {
            const date = document.getElementById('visitDate').value;
            ['afternoon', 'evening'].forEach(s => {
                const count = allBookings
                    .filter(b => b.date === date && b.slot === s)
                    .reduce((sum, b) => sum + (parseInt(b.count) || 1), 0); // æ”¹ç‚ºç´¯åŠ äººæ•¸
                
                document.getElementById(`${s}Count`).textContent = count;
                const badge = document.querySelector(`[data-slot="${s}"] .time-slot-badge`);
                if (count >= 3) { 
                    badge.textContent = "é¡æ»¿"; 
                    badge.className = "time-slot-badge absolute top-2 right-2 px-2 py-1 rounded-full text-[10px] text-white bg-red-500"; 
                } else { 
                    badge.textContent = "å¯é ç´„"; 
                    badge.className = "time-slot-badge absolute top-2 right-2 px-2 py-1 rounded-full text-[10px] text-white bg-green-500"; 
                }
            });
        }

        function renderCalendar(data) {
            const container = document.getElementById('calendarView');
            const today = new Date(); today.setHours(0,0,0,0);
            const firstDay = new Date(currentYear, currentMonth, 1).getDay();
            const lastDate = new Date(currentYear, currentMonth + 1, 0).getDate();

            let html = `<div class="text-center font-bold text-lg mb-4">${currentYear}å¹´ ${currentMonth+1}æœˆ</div>`;
            html += `<div class="grid grid-cols-7 gap-1 text-center font-bold text-blue-
